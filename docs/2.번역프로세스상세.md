# 번역 프로세스 상세 (TDM / BDM)

## 1. 전체 파이프라인 개요
- 번역 작업은 BullMQ `translation_stage` 큐를 통해 스테이지별로 직렬 처리된다. 큐 등록과 워커 설정은 `registerTranslationStageProcessor` 가 맡는다 (`server/services/translationStageQueue.ts:10`, `server/services/translationStageQueue.ts:24`).
- 워커는 스테이지 순서를 `literal → style → emotion → qa`로 고정하고(`server/agents/translation/stageWorker.ts:42`), 각 단계가 끝나면 다음 스테이지 작업을 같은 큐에 다시 적재해 연속성을 유지한다 (`server/agents/translation/stageWorker.ts:234`).
- 모든 스테이지 출력은 Postgres `translation_drafts` 테이블에 축적되어, 이후 Proofread·리뷰 도구와 최종 파일 생성이 동일한 소스를 바라보도록 구성되어 있다 (`server/services/translation/translationDraftStore.ts:82`, `server/db-postgredb-schema.sql:143`).

## 2. TDM (Translation Draft Manager) 로직
### 2.1 역할 정의
- TDM은 스테이지별 LLM 호출, Guard 계산, 재시도, 그리고 결과 저장을 총괄하는 워커 계층을 의미한다. 핵심 진입점은 `handleTranslationStageJob` (`server/agents/translation/stageWorker.ts:49`).

### 2.2 스테이지 실행 흐름
- **Literal:** 컨텍스트(이전/다음 문맥)와 언어 정보를 포함한 프롬프트를 만들고, 낮은 온도로 직역 초안을 생성한다 (`server/agents/translation/prompts/literal.ts:17`, `server/agents/translation/stages/literalStage.ts:13`).
- **Style:** Literal 결과를 입력으로 받아 프로젝트 메모리의 스타일 프로필/용어집을 참조해 문체를 재구성한다 (`server/agents/translation/prompts/style.ts:20`, `server/agents/translation/stages/styleStage.ts:20`).
- **Emotion:** Style 출력과 심볼 테이블을 기반으로 정서/이미지를 재조정한다 (`server/agents/translation/prompts/emotion.ts:20`, `server/agents/translation/stages/emotionStage.ts:20`).
- **QA:** Emotion 결과를 후보 번역으로 보고, 백트랜스·이슈 리스트를 JSON 형식으로 요청한다 (`server/agents/translation/prompts/qa.ts:20`, `server/agents/translation/stages/qaStage.ts:52`).
- 각 스테이지는 `segment.stageOutputs`를 갱신해 후속 단계가 직전 결과에 접근할 수 있도록 한다 (`server/agents/translation/stageWorker.ts:147`).

### 2.3 Guard 및 재시도 전략
- QA 결과는 Guard 평가기를 거쳐 길이·용어·존칭·백트랜스 일치 여부를 기록한다 (`server/services/translation/guards.ts:26`). Guard는 프로젝트 메모리(용어/엔티티/스타일) 정보를 사용해 규칙 기반 점검을 수행한다 (`server/services/translation/guards.ts:53`).
- Guard 실패가 발생하면 시도 횟수에 따라 두 단계의 자동 재시도를 실행한다: (1) 창작성 완화 후 Style부터 재실행 (`server/agents/translation/stageWorker.ts:167`), (2) Literal 온도를 더 낮추고 초기화한 뒤 전체 파이프라인 재시작 (`server/agents/translation/stageWorker.ts:197`). 세 번째 이상 실패 시에는 `needs_review` 플래그만 남기고 종료한다 (`server/agents/translation/stageWorker.ts:230`).

### 2.4 Draft 영속화와 최종화
- 스테이지 결과는 `persistStageResults`를 통해 `translation_drafts`에 upsert된다. 이때 텍스트, 백트랜스, Baseline, Guard, 노트, 재시도 횟수가 함께 저장된다 (`server/services/translation/translationDraftStore.ts:82`).
- QA 이후 최종 스테이지에서는 `finalizeSequentialJob`이 Emotion/QA 결과를 모아 `TranslationFile`과 `TranslationSegment` 문서로 재구성하고, 작업 상태를 `done`으로 바꾼다 (`server/services/translation/sequentialFinalizer.ts:17`, `server/services/translation/sequentialFinalizer.ts:134`).
- 최종화 과정은 Guard 실패 여부(`needs_review`)와 QA 노트를 Proofread 단계까지 전달하며 (`server/services/translation/sequentialFinalizer.ts:161`), Scene summary를 프로젝트 메모리에 병합해 후속 번역에 재활용한다 (`server/services/translation/sequentialFinalizer.ts:214`).

### 2.5 프로젝트 메모리 활용
- 각 스테이지는 `fetchProjectMemory`로 고정 버전의 Project Memory를 불러와 일관된 스타일/용어 기준을 적용한다 (`server/agents/translation/stageWorker.ts:108`, `server/services/translation/memory.ts:52`).

## 3. BDM (Baseline Data Manager) 로직
### 3.1 Baseline 생성
- BDM은 세그먼트별 감정·생동감·메타포·리듬 등 참조 지표를 계산해 저장하는 모듈이다. 기본 구현은 키워드 기반 휴리스틱으로 Baseline을 출력한다 (`server/services/translation/baselines.ts:16`).
- Baseline은 Literal 단계 진입 전에 비어 있는 세그먼트에 대해 선행 계산된다 (`server/agents/translation/stageWorker.ts:80`).

### 3.2 Baseline 전달과 저장
- 생성된 Baseline은 Literal 결과에 부착되고, 이후 Style/Emotion/QA 단계에서도 그대로 전달되거나 상위 단계 값이 없을 때 백업으로 쓰인다 (`server/agents/translation/stages/styleStage.ts:43`, `server/agents/translation/stages/emotionStage.ts:43`, `server/agents/translation/stages/qaStage.ts:90`).
- `persistStageResults`는 Baseline을 JSON으로 직렬화해 `translation_drafts.baseline`에 저장한다. Guard 실패 시 `needs_review` 플래그도 함께 표기되어 Proofread에서 Baseline과 비교 가능하다 (`server/services/translation/translationDraftStore.ts:74`).

### 3.3 Baseline 활용 지점
- 재시도 로직이 Literal 단계로 되돌릴 때, 이전 Baseline을 유지함으로써 Guard 비교 기준이 일관되게 유지된다 (`server/agents/translation/stageWorker.ts:209`).
- QA 단계에서는 Emotion 결과에 Baseline이 없을 경우 기존 값을 사용해 정서적 일관성을 확인하고, 최종 파일 생성 시에도 Baseline 데이터가 segment별 메타데이터로 남는다 (`server/agents/translation/stages/qaStage.ts:90`, `server/services/translation/translationDraftStore.ts:74`).
- 향후 고도화를 위해 Baseline 지표는 Proofread/평가 단계가 동일 기준으로 점검할 수 있는 "참조선" 역할을 수행한다.

## 4. 스테이지별 입출력 요약
| Stage | 주요 입력 | 핵심 LLM 지시 | 대표 출력 |
| --- | --- | --- | --- |
| Literal | 원문 세그먼트 + 앞뒤 컨텍스트 (`server/agents/translation/prompts/literal.ts:21`) | 사실 충실한 직역, 문장 수 유지 (`server/agents/translation/prompts/literal.ts:6`) | 번역 텍스트, Baseline, 호출 메타 (`server/agents/translation/stages/literalStage.ts:25`) |
| Style | Literal 결과 + 스타일 프로필 (`server/agents/translation/prompts/style.ts:32`) | 톤/리듬 조정, 용어 준수 (`server/agents/translation/prompts/style.ts:8`) | 스타일 보정 텍스트 (`server/agents/translation/stages/styleStage.ts:39`) |
| Emotion | Style 결과 + 심볼 테이블 (`server/agents/translation/prompts/emotion.ts:28`) | 정서 강도와 이미지 정렬 (`server/agents/translation/prompts/emotion.ts:8`) | 정서 강조 텍스트 (`server/agents/translation/stages/emotionStage.ts:37`) |
| QA | Emotion 결과 + 용어집 (`server/agents/translation/prompts/qa.ts:31`) | JSON 응답으로 백트랜스/이슈 반환 (`server/agents/translation/stages/qaStage.ts:52`) | 최종 텍스트, Guard, 백트랜스 (`server/agents/translation/stages/qaStage.ts:86`) |

## 5. QA 산출물과 후속 처리
- QA 결과의 Guard는 길이·엔티티·용어·레지스터·백트랜스 항목을 Boolean/Findings 형태로 축적한다 (`server/services/translation/guards.ts:97`).
- Guard가 실패한 세그먼트는 `needs_review`로 표시되어 Proofread가 우선 검토하도록 한다 (`server/services/translation/translationDraftStore.ts:64`).
- 최종 파일 생성 이후 Scene summary를 Project Memory에 병합해, 이후 배치가 동일 지식을 재사용하게 만든다 (`server/services/translation/sequentialFinalizer.ts:214`).

## 6. 운영 및 관측 포인트
- 큐 재시작 시 워커는 자동으로 재등록되지만, 병렬성은 `getTranslationConcurrency` 설정에 의존하므로 모니터링이 필요하다 (`server/services/translationStageQueue.ts:28`).
- OPENAI 키가 없을 경우 스테이지 호출이 즉시 실패하므로, 부트 시 경고 로그를 참고해 환경 구성을 확인해야 한다 (`server/services/translation/llm.ts:23`).
- Guard JSON 파싱 실패 시 QA 노트에 원문 오류 메시지가 저장되어, 추적 가능한 알람을 만들 수 있다 (`server/agents/translation/stages/qaStage.ts:77`).
