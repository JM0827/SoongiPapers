# 교정 프로세스 (Proofreading Pipeline)

## 1. Purpose & Scope

- 번역본을 GPT-5 계열 교정기로 검토하여 문법·스타일 이슈를 구조화된 리포트로 생성한다.
- 서버(TDM)는 Proofreading Agent가 서브피처 실행, LLM 호출, 스트림 전송을 책임지며, 클라이언트(BDM/UI)는 동일 데이터를 활용해 Proofread Editor·워크플로 보드를 구성한다.
- 교정 결과는 Mongo + Postgres 저장소에 영속화되고, 스트림 메타/토큰 사용량을 기반으로 운영 지표를 수집한다.

## 2. Trigger & Entry Points

- `POST /api/projects/:projectId/proofread` 호출 시 Proofreading Agent가 실행되고, 응답은 즉시 NDJSON 스트림을 반환한다 (`server/routes/proofreading.ts`).
- 클라이언트는 `api.requestProofreading`으로 스트림을 구독하여 `progress`, `stage`, `items`, `tier_complete`, `complete`, `error`, `end` 이벤트를 처리한다 (`web/src/services/api.ts`).
- 연결이 끊길 경우 `GET /api/projects/:projectId/proofread/stream?runId=...` 로 SSE 재연결을 시도하며, 실패하면 REST 폴백(`GET /proofread/summary`, `GET /proofread/:runId/items?cursor=...`)으로 상태를 복원한다 (`server/routes/proofreadStream.ts`).
- Proofread Editor는 `/api/projects/:projectId/proofread/editor` + `/proofread/editor/stream` 을 통해 하이라이트/이력 뷰를 갱신한다.

## 3. Environment & LLM Configuration (.env)

| Variable | Default | Purpose | Notes |
| --- | --- | --- | --- |
| `PROOFREADING_MODEL` | `gpt-5` | 교정 기본 모델 | Quick/Deep 티어 모두 동일 시퀀스를 공유한다. |
| `PROOFREADING_MODEL_FALLBACK` | `gpt-5-mini` | 모델 fallback | Responses 오류/429 시 사용. |
| `PROOFREAD_QUICK_MAX_OUTPUT_TOKENS` | `800` | Quick 단계 초기 토큰 | truncation 시 CAP(`PROOFREADING_MAX_OUTPUT_TOKENS_CAP`, 기본 2400)까지 증가. |
| `PROOFREAD_DEEP_MAX_OUTPUT_TOKENS` | `1200` | Deep 단계 초기 토큰 | 동일. |
| `PROOFREADING_MAX_OUTPUT_TOKENS_CAP` | `2400` | 토큰 CAP | Quick/Deep별 설정이 없으면 글로벌 CAP으로 적용. |
| `PROOFREADING_VERBOSITY`, `PROOFREADING_REASONING_EFFORT` | unset | 기본 verbosity/effort | Quick/Deep 전용 값(`PROOFREAD_QUICK_VERBOSITY`, `PROOFREAD_DEEP_EFFORT` 등)이 우선한다. |
| `PROOFREAD_RESPONSES_MAX_RETRIES` | `3` | Responses 재시도 횟수 | 안정화 다운시프트 단계(기본→0.7→0.5)와 함께 사용. |
| `PROOFREAD_HEARTBEAT_MS` | `4000` | 서버 heartbeat 주기(ms) | 최소 3000ms, 기본 4000ms. |
| `DISABLE_STREAM_META_PERSIST` | unset | 스트림 메타 영속화 비활성화 | 테스트 시 `stream_run_metrics` 기록을 건너뛰고 싶을 때 사용. |
| `PROOFREADING_SPEC_PATH` | 내장 spec | 교정 서브피처 구성 파일 경로 | 커스텀 spec 주입 시 사용. |
| `VITE_PROOFREAD_HEARTBEAT_MS` | `60000` | 클라이언트 stall 감지 임계값 | Proofread Agent UI가 heartbeat 지연 여부를 판단. |

## 4. Workflow Orchestration (TDM)

- Proofreading Agent는 `proofread_runs` 테이블로 중복 실행을 차단하고, 기존 결과가 있을 경우 즉시 반환한다 (`server/db/pg.ts`).
- Spec(`server/agents/proofreading/config.ts`)에 정의된 서브피처(Grammar, Style 등)를 `p-limit`으로 제한된 동시성으로 실행하며, `runGenericWorker`가 LLM 호출·다운시프트·페이징·세그먼트 재시도를 담당한다.
- Quick 티어 완료 후 조건에 따라 Deep 티어를 실행하고, 최종 결과를 Mongo `proofreading_files`·Postgres `proofreading_history`에 기록한다.
- Guard/메모리 컨텍스트(QA Guard, Project Memory)는 prompt에 포함돼 위험 구간을 우선적으로 검토하도록 유도한다.

## 5. LLM Invocation Strategy & Safeguards

- OpenAI Responses API + JSON Schema(`proofreadResponseJsonSchemaV2`)를 사용해 구조화된 `items` 페이지를 강제한다.
- 다운시프트 전략: 기본 요청 → `downshift`(limit ×0.7) → `minimal`(limit ×0.5) 순으로 토큰/아이템 수를 줄이며 재시도하고, 2회 후에도 길이가 남으면 `has_more=true`, `next_cursor`로 이어받는다.
- 세그먼트 재시도(`segmentRetry`)는 부분 실패한 문장을 다시 호출해 JSON 파싱 오류나 부분 응답을 최소화한다.
- 모델 시퀀스는 `.env` 설정을 따르며 `gpt-5-mini → gpt-5 → ...` 순으로 fallback한다. Responses 오류/429/길이 초과 시에만 상위 모델로 승격된다.
- 결과는 Payload-L(light) 형태로 받아 서버가 리치 메타(증거, 통계)를 합성한다.

## 6. Data Persistence & BDM Responsibilities

- Mongo `proofreading_files`: Quick/Deep/최종 보고서, 이슈 항목, 하이라이트 적용 상태 저장.
- Postgres `proofread_runs` / `proofreading_history`: 런 dedupe, 상태, 시작/완료 시각 기록.
- Postgres `proofreading_logs`: 서브피처별 LLM 실행(모델, 토큰, 재시도, downshift 등) 기록 (`server/db/proofreadingLog.ts`).
- Postgres `stream_run_metrics`: 연결 횟수, heartbeat, fallback 사유/시간 기록 (`server/services/proofreadStreamMeta.ts`).
- Proofread Editor는 Mongo + Postgres 데이터를 조합해 하이라이트 적용/거부·주석을 관리한다 (`server/routes/proofreadEditor.ts`).

## 7. UX Integration & Status Delivery

- `useProofreadAgent`는 스트림 이벤트를 `useWorkflowStore.proofreading`에 반영하고, `pendingCursors` 큐를 이용해 REST 폴백(`api.fetchProofreadItems`)을 수행한다.
- heartbeat 지연(`VITE_PROOFREAD_HEARTBEAT_MS`) 시 `stalled` 배지를 표시하고, 자동 재연결 1회 이후 실패하면 요약 REST(`api.fetchProofreadSummary`)로 복구한다.
- Left Sidebar/Right Panel activity feed는 `queued → running/recovering → done/failed` 상태, 티어별 완료 메시지, zero-item 알림을 표시한다.
- Proofread Editor 스트림(`/proofread/editor/stream`)은 하이라이트 적용/거부 결과를 실시간으로 반영한다.

## 8. Reliability & Performance Controls

- dedupe: 동일 번역본/메모리/해시 조합은 기존 런을 재사용하거나 `duplicate` 이벤트로 안내한다.
- 다운시프트 + 모델 fallback + 세그먼트 재시도로 길이/429/부분 실패를 완화하고, `needsFollowup` 플래그로 REST 폴백 실패를 표시한다.
- 스트림 내구성: heartbeat(기본 4s), 재연결, REST 폴백으로 긴 교정에서도 데이터 손실을 방지한다.
- Mem 관리: 페이지 히스토리(48개)와 cursor 히스토리(96개) 제한으로 클라이언트 메모리 사용을 제어한다.

## 9. Monitoring & Alerting

- `[ProofSSE] open/heartbeat/items/tier_complete/complete/end` 로그와 `[ProofSSE] stream metrics snapshot` 로그가 스트림 상태를 남긴다.
- `stream_run_metrics` 테이블은 연결/heartbeat/fallback 타임스탬프를 저장해 재연결 SLA 모니터링에 활용한다.
- `proofreading_logs` + `recordTokenUsage`는 서브피처별 토큰·재시도, 모델 선택을 추적한다.
- Admin `/api/admin/proofreading/logs`에서 최근 런, fallback, 다운시프트 현황을 조회한다.
- 향후 대시보드에 first_items_ms, total_ms, downshift/forced pagination 비율, 토큰/건 등 지표를 노출할 계획이다.

## 10. Risks & Next Actions

- Deep 티어 실행 시간이 긴 프로젝트는 비용/SLA를 압박하므로 샘플링·two-pass(감지→정밀 교정) 전략을 검토해야 한다.
- Spec 변경 시 JSON Schema 업데이트를 병행해야 하며 v1/v2 변환 경로가 유지되어야 한다.
- 재연결 + REST 폴백이 모두 실패하는 경우를 대비해 알림/대시보드 연계를 강화할 계획이다.
- 번역 파이프라인(A1.1 하드닝)에도 동일한 다운시프트·페이징·스트림 메타 패턴을 적용해 통일된 워크플로우를 완성할 예정이다.
