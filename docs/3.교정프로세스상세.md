# 교정 프로세스 상세 (Proofreading Pipeline)

## 1. 개요
- 교정 작업은 `runProofreading` 엔트리 포인트로 시작하며, MongoDB에 저장된 최종 번역 텍스트를 불러와 세그먼트 정렬, Guard 상관 분석, 서브피처별 LLM 검수를 수행한다 (`server/agents/proofreading/proofreadingAgent.ts:180`).
- 프로세스는 "Quick"(기본)과 "Deep"(선택) 두 티어로 나뉘며, 각 티어는 Proofreading Spec(JSON)에서 정의한 서브피처를 통해 개별 LLM 호출과 검증 정책을 수행한다 (`server/agents/proofreading/proofreading.spec.json:1`).
- Guard 데이터는 번역 QA 단계에서 축적된 `translation_drafts` 정보를 기반으로 하여, 교정 단계가 번역 Guard 결과와 일관된 문제점을 집중적으로 다루도록 한다 (`server/agents/proofreading/proofreadingAgent.ts:118`).

## 2. 러닝 플로우
1. **입력 로딩**: Mongo에서 원문/번역 텍스트를 가져오고(`server/agents/proofreading/proofreadingAgent.ts:206`), 최종 텍스트 해시 + Memory 버전으로 중복 실행을 차단한다 (`server/agents/proofreading/proofreadingAgent.ts:218`).
2. **히스토리 업데이트**: `proofread_runs`와 `proofreading_history`에 상태를 기록해 중복 실행, 실패 시 롤백 처리를 지원한다 (`server/db/pg.ts:103`, `server/db/pg.ts:39`).
3. **Guard 수집**: QA 스테이지에서 `needs_review` 또는 Guard 실패가 있는 세그먼트를 불러와 교정 검수 시 참조한다 (`server/agents/proofreading/proofreadingAgent.ts:118`).
4. **문장 정렬**: Spec에 정의된 언어/알라이너 옵션으로 한글-영문 문장을 정렬한다 (`server/agents/proofreading/proofreadingAgent.ts:242`). 정렬 결과는 `AlignedPair` 단위(1~N 문장 페어)로 관리되며, 이후 단계에서 청크 단위 처리가 가능하도록 준비된다.
5. **서브피처 실행**: Spec에 정의된 Quick/Deep 서브피처마다 `runGenericWorker`를 통해 LLM 호출을 병렬로 수행하고, Guard 매칭 결과를 컨텍스트로 전달한다 (`server/agents/proofreading/proofreadingAgent.ts:302`). 서브피처는 문장 단위가 아닌 **청크 단위**로 호출되며, Quick 티어는 최대 4~6문장, Deep 티어는 최대 2~3문장으로 묶은 `chunkAlignedPairs` 결과를 사용한다 (`server/agents/proofreading/proofreadingAgent.ts:266`).
6. **결과 버킷화**: 서브피처별 결과를 버킷으로 묶고, 임계값 필터링을 거쳐 보고서를 구성한다 (`server/agents/proofreading/proofreadingAgent.ts:333`).
7. **결과 저장 및 알림**: Mongo Proofreading 문서에 결과를 저장하고, 진행 이벤트(`tier_complete`, `complete`)를 발행한다 (`server/agents/proofreading/proofreadingAgent.ts:375`).

## 3. Proofreading Spec 구조
- Spec 위치: `server/agents/proofreading/proofreading.spec.json`. `PROOFREADING_SPEC_PATH` 환경 변수로 대체 경로 지정을 지원한다 (`server/agents/proofreading/proofreadingHelper.ts:4`).
- 주요 키:
  - `runtime`: 정렬 방식, 워커 수, 청크 크기 등 실행환경 (`server/agents/proofreading/proofreading.spec.json:4`).
  - `groups[].subfeatures[]`: 서브피처별 활성화 여부, 모델, 온도, 시스템 프롬프트를 정의한다 (`server/agents/proofreading/proofreading.spec.json:9`).
  - `tier`: `quick` 또는 `deep`으로 실행 우선순위를 나눈다.
- 중복 키 검증: Spec 로딩 시 서브피처 키 중복을 금지한다 (`server/agents/proofreading/config.ts:87`).

### 3.1 Quick vs Deep 티어
| 티어 | 목적 | 기본 서브피처 | 모델/온도 |
| --- | --- | --- | --- |
| Quick | 즉시 검출이 필요한 문법·스타일 오류 | `grammar_spelling_punct`, `style_register_consistency` | `gpt-4o-mini` @ 0.05 / 0.1 (`server/agents/proofreading/proofreading.spec.json:21`, `server/agents/proofreading/proofreading.spec.json:37`) |
| Deep | 선택적 심층 리뷰 (논리, 정서 등) | 기본 비활성. 옵션에 따라 활성화 (`options.includeDeep`) | `gpt-4o-mini` 범용, 온도 0.1~0.2 (`server/agents/proofreading/proofreading.spec.json:53`) |

- Quick 티어는 Guard에 의해 문제가 없는 세그먼트는 건너뛸 수 있어 성능 최적화가 가능하다 (`server/agents/proofreading/proofreadingAgent.ts:333`).
- Deep 티어는 `includeDeep` 플래그가 true일 때만 실행되며, Quick 완료 후 연결되어 추가 필터링을 수행한다 (`server/agents/proofreading/proofreadingAgent.ts:311`).

### 3.2 처리 단위(Granularity)
- 정렬 이후의 기본 단위는 `AlignedPair`로, 한글/영문 세그먼트를 문장 단위로 매칭한다 (`server/agents/proofreading/proofreadingAgent.ts:242`).
- Quick 티어는 `chunkAlignedPairs`를 사용해 최대 4~6문장(설정 값에 따름)을 하나의 청크로 묶어 LLM에 전달한다 (`server/agents/proofreading/proofreadingAgent.ts:264`).
- Deep 티어는 보다 세밀한 검증을 위해 2~3문장 단위 청크를 사용한다 (`server/agents/proofreading/proofreadingAgent.ts:266`).
- Guard 매칭은 청크 내 번역 텍스트와 QA 단계 세그먼트의 유사도를 비교하여 상위 3개의 세그먼트를 연결하고, 각 청크 결과에 guard 컨텍스트를 첨부한다 (`server/agents/proofreading/proofreadingAgent.ts:150`).

## 4. LLM 호출 및 시스템 프롬프트
- 공통 실행 함수 `runGenericWorker`는 OpenAI Chat Completions API를 호출하며, `p-limit`로 동시 실행 수를 제한한다 (`server/agents/proofreading/genericWorker.ts:15`).
- 각 호출은 Spec 시스템 프롬프트에 프로젝트 공통 가이드라인을 덧붙여 사용한다 (`server/agents/proofreading/proofreadingAgent.ts:320`, `server/agents/prompts/sharedGuidelines.ts:1`).
- 요청 포맷: JSON 응답을 강제(`response_format: { type: "json_object" }`)하며, 사용자 메시지에 작업 키, 제약 조건, Guard 컨텍스트를 포함한다 (`server/agents/proofreading/genericWorker.ts:35`).
- 결과 구조: `items[]` 배열을 추출해 이슈 본문, 권장 수정, 근거, severity를 표준화한다 (`server/agents/proofreading/genericWorker.ts:47`).
- Guard 컨텍스트로 전달된 세그먼트는 이슈 노트에 Guard 기록을 병합해, 번역 단계에서 이미 탐지된 문제와 교정 지적을 연결한다 (`server/agents/proofreading/genericWorker.ts:92`).

### 4.1 서브피처별 시스템 프롬프트 예시
- `grammar_spelling_punct`: 문법/구두점 위주의 고정 프롬프트 (`server/agents/proofreading/proofreading.spec.json:23`).
- `style_register_consistency`: 톤·레지스터 불일치를 최소 2건으로 제한하는 프롬프트 (`server/agents/proofreading/proofreading.spec.json:37`).
- 비활성 상태의 서브피처들도 동일 구조로 Prompt가 정의되어 있어 향후 활성화 시 바로 적용 가능.

## 5. 적용 알고리즘 및 휴리스틱
- **문장 분리기**: 한국어·영어 각각에 특화된 정규식 기반 sentence splitter를 사용해 마침표/따옴표 패턴으로 문장을 추출한다 (`server/agents/proofreading/utils.ts:8`). 언어 미지정 시 일반적인 문장 경계를 사용한다.
- **정렬(Alignment)**: Spec에서 `runtime.aligner`가 `embeddings`인 경우, sentence embedding을 생성한 뒤 동적 계획법(DP)으로 gap-penalized 정렬을 수행해 1:N 매핑을 허용한다 (`server/agents/proofreading/utils.ts:36`, `server/agents/proofreading/embeddingsAligner.ts`). 설정이 `greedy`/`simple`이면 인덱스 기반 1:1 정렬을 수행한다 (`server/agents/proofreading/utils.ts:26`).
- **청크 분할**: `chunkAlignedPairs`가 연속된 `AlignedPair`를 모아 최대 N문장으로 묶는다. Quick 티어는 default 4~6문장, Deep 티어는 2~3문장 청크를 사용하여 LLM 호출 비용과 문맥 품질을 균형 잡는다 (`server/agents/proofreading/proofreadingAgent.ts:250`).
- **Guard 매칭**: QA 단계에서 `needs_review` 플래그가 있거나 Guard를 가진 세그먼트만 선별하고, 교정 청크의 번역 텍스트와 토큰 겹침 비율을 이용해 최고 3개 세그먼트를 연결한다 (`server/agents/proofreading/proofreadingAgent.ts:150`). Guard 점수가 낮으면 LLM 호출을 생략해 빠른 경로를 확보한다 (`server/agents/proofreading/proofreadingAgent.ts:323`).
- **이슈 필터링**: `filterBuckets`가 confidence, severity에 기반해 결과를 정렬·상위 N개로 제한하고, 같은 문장+추천 조합은 dedupe 키로 중복을 제거한다 (`server/agents/proofreading/postProcess.ts:17`).
- **요약 산출**: `recomputeCounts`가 서브피처별 이슈 수를 집계하고, `buildReportMeta`가 생성 시각·언어 정보를 표준화된 스키마로 반환한다 (`server/agents/proofreading/utils.ts:64`, `server/agents/proofreading/postProcess.ts:52`).

## 6. Guard 연계 전략
- QA 단계에서 저장한 Guard 데이터를 교정 시점에 불러와, 동일 세그먼트의 문제점을 우선 점검/노트화한다 (`server/agents/proofreading/proofreadingAgent.ts:118`).
- Guard 매칭은 번역 결과와 교정 청크 간 텍스트 유사도(토큰 교집합 비율)로 계산하여 상위 3개 세그먼트를 선택한다 (`server/agents/proofreading/proofreadingAgent.ts:153`).
- Guard가 문제없다고 판단한 세그먼트는 Quick tier에서 생략 가능하여, 이미 안정적인 구간에 대한 중복 LLM 호출을 줄인다 (`server/agents/proofreading/proofreadingAgent.ts:323`).

## 7. 보고서 구성 및 저장
- 버킷 구조: `pushItems`로 그룹/서브피처별 결과를 축적하고, `filterBuckets`로 신뢰도가 낮은 항목을 제거한다 (`server/agents/proofreading/proofreadingAgent.ts:333`).
- 요약 정보: `recomputeCounts`로 서브피처별 이슈 수를 계산하고, `buildReportMeta`로 변환 메타를 기록한다 (`server/agents/proofreading/proofreadingAgent.ts:353`).
- Mongo 저장: 최종 보고서 및 티어별 중간 보고서를 `saveProofreadingDoc`으로 영속화한다 (`server/agents/proofreading/proofreadingAgent.ts:367`).
- 요약 노트: Quick/Deep 단계별로 한국어/영어 상태 메시지를 설정해 UI가 진행 상황을 번역 없이 표시할 수 있게 한다 (`server/agents/proofreading/proofreadingAgent.ts:344`).

## 8. 진행 이벤트 & UI 연동
- 진행 이벤트는 `onProgress` 콜백을 통해 발행되며, UI 스토어에서 교정 카드 업데이트에 활용된다 (`server/agents/proofreading/proofreadingAgent.ts:286`).
  - `stage`: 서브피처 단위 단계 시작/완료/오류.
  - `tier_complete`: Quick 혹은 Deep 티어 완료 시 전달.
  - `complete`: 전체 교정 완료 및 최종 보고서 제공.
  - `duplicate`: 동일 본문+메모리 버전이 이미 실행 중/완료 상태인 경우.

## 9. 데이터베이스 및 중복 방지
- Postgres `proofread_runs`는 (project_id, translation_file_id, memory_version, final_text_hash)의 유니크 제약으로 동일 텍스트 재실행을 차단한다 (`server/db-postgredb-schema.sql:192`).
- `proofreading_history`는 단계별 상태 추적과 오류 정리를 담당하며, 새 실행 시 이전 `inprogress` 항목을 자동으로 오류 처리한다 (`server/db/pg.ts:59`).

## 10. 운영 고려 사항
- **모델 설정**: Spec은 기본적으로 `gpt-4o-mini`를 사용하지만, 환경에 따라 변경 가능하다. 새로운 모델을 테스트할 때는 Spec JSON에서 서브피처별로 조정한다 (`server/agents/proofreading/proofreading.spec.json:23`).
- **동시성**: `MAX_WORKERS` 환경 변수로 교정 워커 수를 제어하며, Spec의 `runtime.maxWorkers`와 병행 설정을 맞춰야 한다 (`server/agents/proofreading/genericWorker.ts:12`).
- **확장성**: 비활성 서브피처(`enabled: false`)를 활성화하거나 새 그룹을 추가할 때는 키 중복 검사와 UI 카드 매핑을 함께 업데이트한다 (`server/agents/proofreading/config.ts:87`).
- **Guard 연동 실패**: Guard JSON 파싱 오류나 매칭 실패 시 교정은 Guard 없이 계속 진행되지만, 이슈 노트에 Guard 결합 정보가 빠질 수 있다 (`server/agents/proofreading/genericWorker.ts:69`).

## 11. 후속 단계 제안
1. Spec Deep 서브피처(논리/정서) 활성화 시 필요한 추가 UI 표시(중간 보고서) 정의.
2. Guard 없는 세그먼트에 대한 기본 품질 체크(예: 표절/반복)용 보조 서브피처 시험.
3. Proofreading 결과를 번역 메모리(Scene summaries)와 연동해 반복 오류를 예방하는 루틴 설계.
