# 번역 프로세스 (Translation V2)

## 1. Purpose & Scope

- 원문 세그먼트를 LLM 기반 번역(Draft → Revise → Micro-check)으로 처리해 최종 번역본을 산출한다.
- TDM(Task/Decision Manager)은 BullMQ `translation_v2` 큐와 번역 워커를 통해 단계별 실행·재시도·취소를 관리한다.
- BDM(Baseline/Data Manager)은 Draft 결과, 최종 번역 파일, Guard 메타를 저장해 교정·품질 단계가 동일 데이터를 참조하도록 한다.

## 2. Trigger & Entry Points

- `POST /api/pipeline/translate` 가 번역을 개시하며, **저장된 원문 파일 ID(`originDocumentId`)와** 프로젝트/언어/Workflow 정보를 전달한다. 원문 텍스트를 직접 실어 나르는 경로는 호환성용으로만 남아 있다 (`server/index.ts:2785-3105`, `web/src/services/api.ts:1463-1499`).
- 번역 요약/Proofread Editor/페이지네이션 응답은 `canonicalCacheState: 'ready' | 'warming' | 'missing'` 필드를 통해 canonical 세그먼트 캐시 상태를 보고하며, UI는 이 값을 기반으로 즉시 표시/대기 여부를 결정한다. `getTranslationRunSummary` 는 `translation_segment_meta` 로부터 hash 총량을 읽어 `progress.hashes`(version/total/processed/microcheckCompleted)와 `pagination.cursorHash` 를 노출하므로, 진행률과 재개 지점이 항상 canonical 데이터와 동기화된다.
- canonical 세그먼트 생성은 50~100개 단위 chunk로 나뉘어 처리되며 chunk 사이마다 이벤트 루프를 양보하고, Node worker thread(`segmentationWorker.ts`)에서 실행되어 메인 워커의 이벤트 루프가 장시간 블로킹되지 않는다. `prepareOriginSegmentsForJob` 단계도 동일한 worker 기반 `ensureCanonicalSegments` 호출을 사용해 BullMQ 잡의 초기 부트스트랩이 비동기로 수행된다. 동시에 BullMQ `translation_v2` 워커는 `lockDuration`(기본 240 s)과 `stalledInterval`을 확장해 장문 문서에서도 stall 오탐 없이 안정적으로 진행된다.
- 클라이언트는 `api.startTranslation` 으로 호출하며, Chat Assistants와 Right Panel 번역 버튼에서 재사용된다 (`web/src/services/api.ts:1418-1450`).
- 취소는 `POST /api/projects/:projectId/translation/cancel` 로 이루어지며 BullMQ + Postgres 상태를 정리한다 (`server/index.ts:3875-3916`).

## 3. Environment & LLM Configuration (.env)

| Variable                                     | Default                        | Purpose                             | Notes                                                                  |
| -------------------------------------------- | ------------------------------ | ----------------------------------- | ---------------------------------------------------------------------- |
| `TRANSLATION_DRAFT_MODEL_V2`                 | `gpt-5-mini`                   | Draft 단계 기본 모델                | 운영에서는 `gpt-5` 로 오버라이드하여 품질 확보.                        |
| `TRANSLATION_DRAFT_VALIDATION_MODEL_V2`      | `gpt-5-mini`                   | Draft 단계 fallback 모델            | 응답 오류·JSON 실패 시 사용.                                           |
| `TRANSLATION_DRAFT_VERBOSITY_V2`             | `medium`                       | Draft Responses `text.verbosity`    | 자동 재시도 시 `high` 까지 승격.                                       |
| `TRANSLATION_DRAFT_REASONING_EFFORT_V2`      | `medium`                       | Draft Responses `reasoning.effort`  | 재시도 시 최댓값까지 상승.                                             |
| `TRANSLATION_DRAFT_MAX_OUTPUT_TOKENS_V2`     | `2200`                         | Draft 초기 토큰 예산                | truncation 시 CAP 까지 2배씩 증가.                                     |
| `TRANSLATION_DRAFT_MAX_OUTPUT_TOKENS_CAP_V2` | `6400`                         | Draft 토큰 상한                     | 초과 시 세그먼트 분할 후 재시도.                                       |
| `TRANSLATION_DRAFT_CANDIDATES`               | `1`                            | Draft 후보 개수(1-3)                | 2 이상 시 deliberation 모델 사용.                                      |
| `TRANSLATION_DRAFT_JUDGE_MODEL_V2`           | fallback 또는 `gpt-5-mini`     | 후보 선택 모델                      | `TRANSLATION_DRAFT_JUDGE_MAX_OUTPUT_TOKENS_V2`(기본 768)와 함께 작동.  |
| `TRANSLATION_REVISE_MODEL_V2`                | `CHAT_MODEL` 또는 `gpt-5-mini` | Revise 단계 기본 모델               | 운영에서는 `gpt-5` 로 권장.                                            |
| `TRANSLATION_REVISE_VALIDATION_MODEL_V2`     | `gpt-5-mini`                   | Revise fallback                     | Draft와 동일 로직.                                                     |
| `TRANSLATION_REVISE_VERBOSITY_V2`            | `medium`                       | Revise Responses `text.verbosity`   | 재시도 시 `high` 까지 승격.                                            |
| `TRANSLATION_REVISE_REASONING_EFFORT_V2`     | `low`                          | Revise Responses `reasoning.effort` | 재시도 시 단계적으로 증가.                                             |
| `TRANSLATION_REVISE_MAX_OUTPUT_TOKENS_V2`    | `1400`                         | Revise 초기 토큰 예산               | truncation → CAP (`TRANSLATION_REVISE_MAX_OUTPUT_TOKENS_CAP_V2=3600`). |
| `TRANSLATION_V2_DEBUG`                       | unset                          | 상세 로깅 토글                      | `true/1/yes` 시 세그먼트별 디버그 출력.                                |

## 4. Workflow Orchestration (TDM)

- 원문 업로드 이후 `segmentOriginText` 가 문단/문장 기반 세그먼트를 생성하고 Project Memory와 번역 노트를 준비한다. 세그먼트 생성/영속화는 번역 워커(`handleTranslationV2Job`) 내에서 수행되며, HTTP 라우트는 원문 파일 ID만 큐에 전달한다 (`server/agents/translation/segmentationAgent.ts:106-216`, `server/index.ts:4065-4910`).
- canonical 캐시가 비어 있을 경우 별도 BullMQ 큐(`translation_canonical_warmup`)가 세그먼트를 백그라운드에서 재계산한다. 클라이언트는 `POST /api/projects/:projectId/translations/:jobId/canonical/warmup`으로 워밍업을 요청하며, 완료 시 `canonicalCacheState`가 `ready`로 전환된다.
- `translation_v2` BullMQ 작업에는 Draft/Revise/Micro-check 단계 정보와 Guard 대상 세그먼트가 포함된다 (`server/services/translationV2Queue.ts:12-51`).
- 워커(`handleTranslationV2Job`)는 Draft → Revise → Micro-check 순으로 실행하며, 각 단계 종료 후 `persistStageResults`로 Postgres `translation_drafts` 를 갱신한다 (`server/index.ts:3522-3853`).
- 완료 시 번역 파일을 `variant='final'` 로 업서트하고 이전 세그먼트를 교체한다 (`server/index.ts:3774-3825`).

## 5. LLM Invocation Strategy & Safeguards

- Draft/Revise 모두 OpenAI Responses API + JSON Schema를 사용해 세그먼트별 출력 구조를 강제한다.
- 세그먼트 길이/토큰 추정을 기반으로 요청을 분할하며, truncation 발생 시 세그먼트를 재분할하거나 토큰/CAP을 조정한다 (`server/index.ts:181-342`).
- 후보 번역이 2개 이상이면 `TRANSLATION_DRAFT_JUDGE_MODEL_V2`로 deliberation을 수행해 최적 후보를 선택한다 (`server/agents/translation/translationDraftAgent.ts:521-700`).
- Revise 단계는 Draft 결과와 span 매핑을 받아 재시도 시 Verbosity/Effort를 단계적으로 높이고 fallback 모델을 최종 사용한다 (`server/agents/translation/reviseAgent.ts:74-214`).
- Micro-check 단계는 비LLM Guard(길이 비율 0.7~1.3)를 적용해 LLM 호출 없이 안정성을 확보한다 (`server/services/translation/microCheckGuard.ts:12-58`).

## 6. Data Persistence & BDM Responsibilities

- Postgres `translation_drafts` 는 단계별 텍스트, 후보, Guard 결과를 보관한다.
- Mongo `translation_files` 는 최종 번역 및 단계별 미리보기를 저장하고 Proofread/Quality가 동일 데이터를 사용하도록 한다 (`server/index.ts:3774-3806`).
- Guard 결과와 Needs-review 플래그는 Proofread/Quality에서 하이라이트되어 리뷰 집중을 돕는다 (`server/index.ts:3755-3764`).

## 7. UX Integration & Status Delivery

- `useTranslationAgent` 가 `/api/jobs`, SSE, NDJSON 응답을 폴링/스트리밍해 `useWorkflowStore.translation` 상태를 갱신한다 (`web/src/hooks/useTranslationAgent.ts`).
- 상태는 `idle → queued → running → done/failed/cancelled` 로 표시되고, 진행률/스테이지 라벨이 Left Sidebar와 Right Panel 번역 카드에 노출된다 (`web/src/components/layout/LeftSidebar.tsx:892-918`).
- 완료 시 Right Panel 번역 탭과 Proofread 탭이 자동 새로고침되며, Chat Assistant가 진행 상황을 요약한다 (`server/routes/chat.ts:1411-1550`).

## 8. Reliability & Performance Controls

- Draft 단계는 최대 3세그먼트 묶음으로 batching, truncation 시 자동 재분할하여 대용량 텍스트도 안정적으로 처리한다.
- BullMQ 재시도/백오프와 `jobs` 테이블 상태 동기화로 장애 시 자동 재시도 또는 명확한 실패 상태가 남는다.
- `TRANSLATION_DRAFT_CANDIDATES` 를 1로 유지하면 비용 절감, 2~3으로 늘리면 deliberation 비용이 증가하므로 상황별 튜닝이 필요하다.
- Micro-check Guard가 LLM 없이 길이 비율을 검증해 고비용 호출 없이 기본 품질을 확보한다.

## 9. Monitoring & Alerting

- `[TRANSLATION_V2]` 로그가 세그먼트 분할·재시도·실패 지점을 남겨 장애 분석에 활용된다.
- Postgres `translation_drafts`, `jobs`, `workflow_runs` 는 Admin 대시보드에서 최근 실행/토큰/상태를 노출한다.
- `recordTokenUsage` 이벤트(`translate_v2_draft`, `translate_v2_revise`)가 토큰·비용을 단계별로 집계한다 (`server/index.ts:3556-3715`).

## 10. Risks & Next Actions

- 초장문 세그먼트는 반복 분할에도 truncation이 남을 수 있으므로, 사전 세그멘테이션 튜닝(문단/문장 모델 개선)을 검토한다.
- BullMQ 큐 적체 시 번역 지연이 발생할 수 있으므로, 워커 수/우선순위 기반 스케줄링을 주기적으로 조정한다.
- Draft 후보를 2 이상으로 사용하는 프로젝트는 deliberation 모델 지연/비용을 모니터링하고 성능 기준을 재평가해야 한다.
