# 번역 프로세스 상세 (Translation V2)

## 1. 전체 파이프라인 개요 (TDM 관점)
- 번역 요청이 들어오면 원문을 세그먼트화하고 프로젝트 메모리를 준비한 뒤 `translation_v2` BullMQ 큐에 잡을 등록한다 (`server/index.ts:2236-2474`, `server/services/translationV2Queue.ts:12-51`). 이 지점을 번역 Draft Manager(TDM)의 진입점으로 볼 수 있다.
- 워커는 `registerTranslationV2Processor` 를 통해 단일 프로세서로 등록되며, 큐에서 잡을 꺼내 `handleTranslationV2Job`을 실행한다 (`server/services/translationV2Queue.ts:33-43`, `server/index.ts:3522-3853`).
- TDM은 `draft → revise → micro-check` 세 단계로 구성되어 있으며 `V2_PIPELINE_STAGES` 상수로 관리된다 (`server/index.ts:143`). 각 단계가 끝날 때마다 `persistStageResults`로 `translation_drafts` 테이블에 업서트하여 후속 단계가 동일 데이터를 소비하도록 한다 (`server/services/translation/translationDraftStore.ts:122-221`).
- 단계별 토큰 사용량과 실행 메타데이터는 `recordTokenUsage` 이벤트로 집계되고, 실패 시 워크플로우 런까지 정리하는 TDM의 모니터링/복구 기능이 포함된다 (`server/index.ts:3529-3569`, `server/index.ts:3733-3780`).

## 2. Draft 단계
- `runDraftStageWithAdaptiveRetries`가 전체 원문 세그먼트를 입력받아 재귀적으로 묶음을 분할한 뒤 Draft 에이전트를 호출한다 (`server/index.ts:181-342`).
  - 세그먼트 묶음이 `MAX_SEGMENTS_PER_REQUEST`(기본 3)보다 크면 반씩 나누고, 토큰 상한(`DRAFT_MAX_OUTPUT_TOKENS_CAP`)을 초과하면 다시 분할해 재시도한다.
  - 단일 세그먼트가 길어 잘리는 경우 `splitOriginSegmentForRetry`로 문장 단위 분할을 시도한다.
- 각 묶음은 `generateTranslationDraft`로 전달되어 OpenAI Responses API를 통해 후보 번역을 생성한다 (`server/agents/translation/translationDraftAgent.ts:347-520`, `server/agents/translation/translationDraftAgent.ts:521-700`).
  - JSON Schema 강제, 최대 토큰 자동 증가, syntax 오류 시 재시도, 후보별 scoring/notes 구조 등이 포함된다.
  - 멀티 후보가 활성화된 경우 후보 분석과 선택 결과(`candidates`)가 세그먼트 메타에 함께 저장된다.
- Draft 단계에서 얻은 세그먼트는 `stage='draft'`로 `translation_drafts`에 저장되며, 순간 토큰 사용량은 `translate_v2_draft` 이벤트로 집계된다 (`server/index.ts:3564-3592`).

## 3. Revise 단계
- Draft 결과를 입력으로 `generateTranslationRevision`을 호출해 문체/맥락을 보정한다 (`server/index.ts:3634-3723`, `server/agents/translation/reviseAgent.ts:161-360`).
  - Revise 에이전트 역시 JSON Schema 기반의 Responses API 호출을 사용하며, 출력이 잘리면 토큰 예산을 키워 재시도한다.
  - 출력에는 보정된 본문과 span 매핑이 포함되어 QA·Proofread에서 참조할 수 있다.
- Revise 단계 결과는 `stage='revise'`로 `translation_drafts`에 기록되고, 토큰 사용량은 `translate_v2_revise` 이벤트로 측정된다 (`server/index.ts:3696-3715`).

## 4. Micro-check 단계
- Revise 이후에는 LLM을 호출하지 않고, `runMicroChecks`가 길이 비율과 같은 경량 점검을 수행한다 (`server/index.ts:3733-3772`, `server/services/translation/microCheckGuard.ts:12-58`).
  - 현재는 세그먼트 길이 비율(0.7~1.3)만 검사하며, 실패 시 Guard Findings와 `needs_review` 플래그가 기록된다.
- Micro-check 결과는 `stage='micro-check'`로 `translation_drafts`에 저장되어 Proofread/리포트에서 그대로 활용된다 (`server/index.ts:3755-3764`).

## 5. 최종화 및 BDM 역할
- Draft/Revise/Micro-check가 모두 끝나면 결과 텍스트를 합쳐 `TranslationFile`을 `variant='final'` 상태로 upsert 한다 (`server/index.ts:3774-3806`). 이 시점이 Baseline Data Manager(BDM)에서 “최종본 확정”에 해당한다.
- 기존 `TranslationSegment`의 `variant='final'` 데이터를 삭제하고, Revise 출력과 Micro-check Guard 정보를 포함한 새 세그먼트를 삽입한다 (`server/index.ts:3803-3825`). 저장되는 메타데이터에는 다음이 포함된다.
  - Revise 결과 (문체 보정본)
  - Micro-check Guard 결과 (`synthesis_notes.guards`, `guardFindings`, `needsReview`)
  - 향후 Proofread 편집기와 품질 리포트가 동일 데이터에 접근하도록 하는 BDM의 데이터 정규화 책임
- 작업이 완료되면 BullMQ 잡 상태는 `done`, `jobs` 테이블은 `status='done'`으로 업데이트되고, 워크플로우 런이 존재하면 성공 상태로 종료한다 (`server/index.ts:3827-3853`).

- 관측 가능 항목: 스테이지별 토큰 사용량, 모델/verbosity/effort, maxOutputTokens, 재시도 횟수, truncation 여부, Guard 위반 건수 (`server/index.ts:3556-3569`, `server/index.ts:3688-3715`, `server/index.ts:4067-4141`).
- 실패 시나리오: Draft/Revise 출력 truncation 반복, LLM 응답 비어 있음 → TDM이 즉시 실패 처리하고 워크플로우를 정리 (`server/index.ts:3580-3589`, `server/index.ts:3677-3686`).
- 취소 요청 → 큐에서 잡 제거, `translation_drafts`의 `needs_review` 초기화, 취소 로그 남김 (`server/index.ts:3875-3916`).

- 번역 개시 시 `buildMemorySeed`가 캐릭터/용어/측정 단위 등 핵심 정보를 Project Memory에 병합해 이후 스테이지가 동일 컨텍스트를 공유하도록 한다 (`server/index.ts:2463-2471`, `server/index.ts:4268-4352`).
- 완결된 번역은 Proofread 편집기와 품질 검토에서 동일 데이터를 소비하게 되며, Micro-check에서 `needs_review=true`가 붙은 세그먼트는 후속 단계가 우선 검토하도록 설계되어 있다. BDM은 이렇게 정규화된 데이터(세그먼트, Guard, Baseline)를 유지하며 Proofread/Quality 파이프라인이 참조할 수 있게 한다 (`server/services/translation/sequentialFinalizer.ts:186-224`).

---
**담당**
- Owner: Translation Platform Team
- 최근 업데이트: 2025-??-?? (GPT-5 기반 Translation V2 반영)
