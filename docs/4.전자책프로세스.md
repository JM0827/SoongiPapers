# 전자책 생성 프로세스 상세

## 1. 개요
- 전자책 파이프라인은 프로젝트별 `ebooks` 레코드를 생성하고, 번역 결과·품질 검토·커버 이미지를 수집해 EPUB/PDF 자산을 만든다.
- 서버 측 주요 구성요소: `server/routes/ebooks.ts` (API), `server/services/cover/coverService.ts` (커버 및 이미지 생성), Postgres의 `ebooks`·`ebook_versions`·`ebook_assets` 등.
- 프런트엔드에서는 `web/src/components/export/ExportPanel.tsx`가 `/api/projects/:projectId/ebook` 응답을 표시하고 다운로드/재생성을 제어한다.

## 2. 데이터 모델
- **ebooks** (`server/db-postgredb-schema.sql:244`)
  - `ebook_id`와 `project_id` 1:1, `status` (`draft`/`cover-queued`/`cover-ready`/`publishing` 등), `title/author/translator`, `source_language/target_language`, `synopsis`, `current_version_id`.
- **ebook_versions** (`server/db-postgredb-schema.sql:175`)
  - 각 전자책 빌드 버전. `translation_file_id`, `quality_assessment_id`, `export_format`, `word_count`, `character_count`, `created_by` 등.
- **ebook_assets** (`server/db-postgredb-schema.sql:206`)
  - 실파일 저장소 메타. 커버(front/back/spine/wrap, MIME=image/jpeg)와 본문(manuscript, MIME=application/epub+zip 등) 자산 모두 기록. `public_url`, `checksum`, `size_bytes`, `source` 등 포함.
- **ebook_cover_sets** (`server/db-postgredb-schema.sql:262`)
  - 커버 작업 그룹. `status`, `summary_snapshot`, `prompt`, `writer_note`, `translator_note`, `isbn`, `is_current`.
- **ebook_metadata**, **ebook_distribution_channels**, **ebook_audit_log** 등 부가 테이블로 메타데이터·배포 채널·감사를 관리.

## 3. 전자책 API (server/routes/ebooks.ts)
1. `GET /api/projects/:projectId/ebook`: 프로젝트 검증 후 `ebooks`, 최신 `ebook_versions`, `ebook_assets`, `ebook_metadata`, `ebook_distribution_channels`를 join해 ExportPanel에 필요한 상태를 반환 (`server/routes/ebooks.ts:186`).
2. `GET /api/projects/:projectId/ebook/download/:assetId`: `ebook_assets`에서 원고(`asset_type='manuscript'`)를 찾아 파일 스트리밍 (`server/routes/ebooks.ts:170`).
3. `GET /api/projects/:projectId/cover`: 커버 세트 개요와 fallback URL을 제공 (`server/routes/ebooks.ts:24`).
4. `POST /api/projects/:projectId/cover/regenerate`: 번역 프로파일 요약이 준비됐을 때 새 커버 세트를 큐잉 (`server/routes/ebooks.ts:57`).
5. `GET /api/projects/:projectId/cover/image/:assetId`: 저장된 커버 이미지를 스트리밍 (`server/routes/ebooks.ts:106`).
6. `GET /api/projects/:projectId/translations`: 전자책 빌드에 사용할 수 있는 `TranslationFile` 목록과 품질 점수를 제공해 버전 선택이 가능하게 한다 (`server/routes/ebooks.ts:216`).
*모든 라우트는 `requireAuthAndPlanCheck`를 거쳐 플랜/권한을 확인한다.*

## 4. 커버 생성 파이프라인
### 4.1 큐잉 (coverService.queueCoverRegeneration)
- 입력: 프로젝트 ID, 제목, 작가/번역가, 타깃 언어, 번역 요약, 작가·번역가 노트, ISBN, translationProfileId 등 (`server/services/cover/coverService.ts:13`).
- 흐름
  1. `ensureInitialized()`로 저장 디렉터리 생성 + `AIImageService` 초기화 (Gemini API 키 필요) (`server/services/cover/coverService.ts:70`).
  2. `ensureEbook`으로 `ebooks` 레코드 생성/업데이트 (`status='cover-queued'`) (`server/services/cover/coverService.ts:420`).
  3. 기존 `queued/generating` 커버 세트 존재 시 `cover_job_pending` 오류.
  4. `ebook_cover_sets`에 새 row 삽입 (`status='queued'`, summary snapshot 유지) 후 `jobs` 테이블에 `type='cover'` 작업 생성, audit log에 `cover_queue` 이벤트 기록 (`server/services/cover/coverService.ts:240`).

### 4.2 워커 실행 (coverService.processCoverJob)
- `startCoverWorker` (서버 부트 시 `server/index.ts:2926`)가 Postgres `jobs` 큐에서 작업을 꺼내 `coverService.processCoverJob` 호출.
- 처리 단계 (`server/services/cover/coverService.ts:283`):
  1. `ebook_cover_sets`를 `FOR UPDATE`로 잠그고 `status='generating'`.
  2. `buildCoverPrompt`로 wraparound 커버 전용 프롬프트 생성 (언어 지침 포함) (`server/services/cover/coverService.ts:96`).
  3. `generateSvg(prompt)` → `AIImageService`가 Google Gemini 모델(기본 `gemini-2.5-flash`, env `GEMINI_MODEL`)에 요청하여 SVG 결과 획득 (`server/services/cover/coverService.ts:72`).
  4. `createCoverVariants`가 Sharp로 wrap/front/spine/back PNG 버전을 생성하고 SHA-256 체크섬 및 크기를 계산.
  5. `storeCoverAssets`가 파일을 `storage/covers`에 저장하고 `ebook_assets`에 front/back/spine/wrap + SVG 항목을 insert (`server/services/cover/coverService.ts:660`).
  6. `ebook_cover_sets.status='ready'`, `is_current=TRUE`, `prompt` 저장; `ebooks.status='cover-ready'` 갱신.
  7. Audit log에 `cover_generated` 이벤트 기록, `jobs` 상태를 `done`으로 마크.

### 4.3 실패 처리
- Gemini 호출/파일 저장/DB 오류 시 `handleCoverFailure`가 `status='failed'`, `failure_reason`을 업데이트하고 audit에 `cover_failed` 이벤트 추가 (`server/services/cover/coverService.ts:820`).
- `jobs` 테이블에도 `status='failed'`, `last_error`를 남겨 UI가 재시도 버튼을 노출할 수 있다.

## 5. 전자책 산출물
- 커버 외 본문 자산은 번역 완료 후 export 파이프라인이 `ebook_versions`와 `ebook_assets`를 채운다. (예: EPUB 생성기가 `asset_type='manuscript'` 파일을 생성 → `ebook_assets` insert → `/ebook/download/:assetId`에서 다운로드)
- 저장 경로: `storage/ebooks/<subpath>/filename`. 다운로드 시 `ebook_assets.file_path`를 루트(`EBOOK_STORAGE_DIR`)에 상대 경로로 join한다 (`server/routes/ebooks.ts:170`).
- `ebook_versions`는 `translation_file_id`와 `quality_assessment_id`를 연결해 어떤 번역본/품질 점수를 사용했는지 추적한다.

## 6. Gemini 사용 세부사항
- CoverService 초기화 시 `GEMINI_API_KEY`가 없으면 즉시 예외를 던져 커버 생성이 차단된다 (`server/services/cover/coverService.ts:70`).
- `AIImageService` 초기화 시 모델 명(`process.env.GEMINI_MODEL`)이 없으면 기본 `gemini-2.5-flash`를 사용한다.
- 생성된 자산 메타데이터 `source` 필드에 `ai:gemini-2.5-flash`가 기록되어 감사 가능 (`server/services/cover/coverService.ts:784`).
- 프롬프트에는 제목/요약/언어 지침/레이아웃 요구 사항이 포함돼 상업용 품질의 wrap 커버를 지시한다 (`server/services/cover/coverService.ts:96`).

## 7. 프런트엔드 연동
- `ExportPanel` (`web/src/components/export/ExportPanel.tsx`)
  - 마운트 시 `/api/projects/:projectId/ebook` 호출 → 상태, 최신 버전, 커버 프리뷰, 다운로드 링크 표시 (`web/src/components/export/ExportPanel.tsx:363`).
  - 커버 재생성 버튼 → `/cover/regenerate` POST 후 로딩/오류 상태 표시 (`web/src/components/export/ExportPanel.tsx:783`).
  - 다운로드 버튼은 `/ebook/download/:assetId`를 호출해 파일을 저장 (`web/src/components/export/ExportPanel.tsx:399`).
- `useProjectContext` (`web/src/hooks/useProjectContext.ts:60`)가 `ebookMeta`를 글로벌 상태로 유지해 타임라인/챗봇이 "Publishing" 진행 상황을 표현한다.

## 8. 감사 및 모니터링
- 모든 커버 이벤트가 `ebook_audit_log`에 저장되어 누가 언제 큐잉/생성/실패했는지 추적 가능 (`server/services/cover/coverService.ts:318`).
- `ebook_assets.checksum`과 크기로 파일 무결성을 검증한다.
- 커버 작업 실패 시 사용자에게 409/500 오류를 돌려주며, ExportPanel에서 재시도 버튼을 제공한다.

## 9. 향후 고려사항
1. EPUB/PDF 생성기의 세부 설계 문서화 및 자동 배포 채널 연계.
2. Gemini 호출/비용 모니터링 대시보드 연동.
3. 사용자 정의 커버 업로드(수동 커버 교체) 옵션 검토.
